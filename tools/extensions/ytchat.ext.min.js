var AC_ClickableChats = [
  'yt-live-chat-text-message-renderer',
  'yt-live-chat-paid-message-renderer',
  'yt-live-chat-membership-item-renderer',
  'yt-live-chat-paid-sticker-renderer',
];
function AC_Declutter() {
  $('#contents yt-live-chat-poll-renderer').addClass('avidcaster-hidden');
  $('#visible-banners yt-live-chat-banner-header-renderer')
    .closest('#visible-banners')
    .addClass('avidcaster-hidden');
  $('#card.yt-live-chat-viewer-engagement-message-renderer')
    .closest('#card')
    .addClass('avidcaster-hidden');
  $('#container .yt-live-chat-restricted-participation-renderer')
    .closest('#input-panel')
    .addClass('avidcaster-hidden');
  $('#container .yt-live-chat-message-input-renderer')
    .closest('#input-panel')
    .addClass('avidcaster-hidden');
}
function AC_Reclutter() {
  $('#contents yt-live-chat-poll-renderer').removeClass('avidcaster-hidden');
  $('#visible-banners yt-live-chat-banner-header-renderer')
    .closest('#visible-banners')
    .removeClass('avidcaster-hidden');
  $('#card.yt-live-chat-viewer-engagement-message-renderer')
    .closest('#card')
    .removeClass('avidcaster-hidden');
  $('#container .yt-live-chat-restricted-participation-renderer')
    .closest('#input-panel')
    .removeClass('avidcaster-hidden');
  $('#container .yt-live-chat-message-input-renderer')
    .closest('#input-panel')
    .removeClass('avidcaster-hidden');
}
function AC_GetAuthorName(element) {
  element.find('#author-name #tooltip.hidden').remove();
  var authorName = element.find('#author-name').text();
  return authorName;
}
function AC_GetAuthorImage(element) {
  var authorImage = element.find('#img').attr('src').replace('s32', 's256').replace('s64', 's256');
  return authorImage;
}
function AC_GetAuthorBadge(element) {
  var authorBadge = element
    .find('#chat-badges .yt-live-chat-author-badge-renderer img')
    .attr('src');
  return authorBadge;
}
function AC_GetMessage(element) {
  element.find('#message hidden').remove();
  element.find('#message font').contents().unwrap();
  element.find('#message').children().not('img').remove();
  element.find('#message').children().removeClass();
  var message = element.find('#message').html();
  return message;
}
function AC_GetMembership(element) {
  var primaryText = element
    .find('.yt-live-chat-membership-item-renderer #header-primary-text')
    .html();
  var secondaryText = element.find('.yt-live-chat-membership-item-renderer #header-subtext').html();
  if (primaryText && secondaryText) {
    return primaryText + ' ' + secondaryText;
  }
  if (primaryText) {
    return primaryText;
  }
  if (secondaryText) {
    return secondaryText;
  }
}
function AC_GetDonationAmount(element) {
  var donationAmount = element.find('#purchase-amount').text();
  if (!donationAmount) {
    donationAmount = element.find('#purchase-amount-chip').text();
  }
  return donationAmount?.replace(/\s\s+/g, ' ').trim();
}
function AC_PostMessageSouthBound(data) {
  data = { type: 'avidcaster-overlay-south-bound', action: 'yt-chat', payload: data };
  document.getElementById('avidcaster-iframe').contentWindow.postMessage(data, '*');
}
function AC_DisableHotLinks(element) {
  element.addClass('avidcaster-unclickable');
}
function AC_ListenForClicks() {
  $('body')
    .off('click')
    .on('click', AC_ClickableChats.join(','), function () {
      if ($(this)[0].hasAttribute('is-deleted')) {
        $(this).addClass('avidcaster-deleted');
        return;
      }
      $(this).addClass('avidcaster-dispatched');
      $(this).find('yt-live-chat-paid-message-renderer').addClass('avidcaster-dispatched');
      var clicked = $(this).clone();
      var data = { message: '', authorName: '', authorImage: '', donation: '', membership: '' };
      data.authorName = AC_GetAuthorName(clicked);
      data.authorImage = AC_GetAuthorImage(clicked);
      data.message = AC_GetMessage(clicked);
      data.membership = AC_GetMembership(clicked);
      data.donation = AC_GetDonationAmount(clicked);
      AC_PostMessageSouthBound(data);
    });
}
function AC_ListenToParent() {
  window.addEventListener(
    'message',
    (event) => {
      if (event.data.type === 'avidcaster-overlay-north-bound') {
        switch (event.data.action) {
          case 'declutter':
            AC_Declutter();
            break;
          case 'reclutter':
            AC_Reclutter();
            break;
          default:
            break;
        }
      }
    },
    false
  );
}
function AC_ListenForNewChat() {
  AC_SelectOnInsertion(
    '.yt-live-chat-item-list-renderer#items',
    'yt-live-chat-text-message-renderer',
    function (element) {
      AC_DisableHotLinks($('#message > a'));
      if (AC_WordsList.length) {
        var chatWords = $(element)
          .find('#message')
          .text()
          .toLowerCase()
          .replace(/\s\s+/g, ' ')
          .trim()
          .split(' ');
        var match = chatWords.filter((value) => AC_WordsList.includes(value)).length > 0;
        switch (AC_WordsAction) {
          case 'highlight':
            if (match) {
              $(element).addClass('avidcaster-highlighted');
            }
            break;
          case 'filter':
            if (!match) {
              $(element).addClass('avidcaster-filtered');
            }
            break;
          default:
            break;
        }
      }
    }
  );
}
AC_DisableHotLinks($('#message > a'));
AC_ListenForClicks();
AC_ListenToParent();
AC_ListenForNewChat();
